---

- name: build a new image for the Wordpress web site
  hosts: localhost

  vars_prompt:
     - name: "registry_password"
       prompt: "please, enter registry password"
       private: yes

  tasks:
     - name: Gather context
       command: cd .. && ./make_env.sh

     - name: login to the gitlab registry
       docker_login:
         registry: "{{registry_url}}"
         username: "{{registry_user}}"
         password: "{{registry_password}}"
         reauthorize: yes

     - docker_service:
         project_src: ..
         build: yes
       register: compose_output

     - debug:
         msg: "{{compose_output}}"

     - name: Tag and push to the registry
       vars:
           image_name: "{{ lookup('ini', 'IMAGE_NAME type=properties file=../.env') }}"
           image_version: "{{ lookup('ini', 'VERSION type=properties file=../.env') }}"
       docker_image:
         name: "{{registry_url}}/{{ image_name }}"
         repository: "{{registry_url}}/{{ image_name }}"
         tag: "{{ image_version }}"
         pull: no
         push: yes
         force: yes
